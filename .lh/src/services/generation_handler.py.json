{
    "sourceFile": "src/services/generation_handler.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1770134305752,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1770134305751,
            "name": "Commit-0",
            "content": "\"\"\"Generation handler for Flow2API\"\"\"\r\nimport asyncio\r\nimport base64\r\nimport json\r\nimport time\r\nfrom typing import Optional, AsyncGenerator, List, Dict, Any\r\nfrom ..core.logger import debug_logger\r\nfrom ..core.config import config\r\nfrom ..core.models import Task, RequestLog\r\nfrom .file_cache import FileCache\r\n\r\n\r\n# Model configuration\r\nMODEL_CONFIG = {\r\n    # 图片生成 - GEM_PIX (Gemini 2.5 Flash)\r\n    \"gemini-2.5-flash-image-landscape\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_LANDSCAPE\"\r\n    },\r\n    \"gemini-2.5-flash-image-portrait\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_PORTRAIT\"\r\n    },\r\n\r\n    # 图片生成 - GEM_PIX_2 (Gemini 3.0 Pro)\r\n    \"gemini-3.0-pro-image-landscape\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_LANDSCAPE\"\r\n    },\r\n    \"gemini-3.0-pro-image-portrait\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_PORTRAIT\"\r\n    },\r\n    \"gemini-3.0-pro-image-square\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_SQUARE\"\r\n    },\r\n    \"gemini-3.0-pro-image-four-three\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_LANDSCAPE_FOUR_THREE\"\r\n    },\r\n    \"gemini-3.0-pro-image-three-four\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_PORTRAIT_THREE_FOUR\"\r\n    },\r\n\r\n    # 图片生成 - GEM_PIX_2 (Gemini 3.0 Pro) 2K 放大版\r\n    \"gemini-3.0-pro-image-landscape-2k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_LANDSCAPE\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_2K\"\r\n    },\r\n    \"gemini-3.0-pro-image-portrait-2k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_PORTRAIT\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_2K\"\r\n    },\r\n    \"gemini-3.0-pro-image-square-2k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_SQUARE\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_2K\"\r\n    },\r\n    \"gemini-3.0-pro-image-four-three-2k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_LANDSCAPE_FOUR_THREE\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_2K\"\r\n    },\r\n    \"gemini-3.0-pro-image-three-four-2k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_PORTRAIT_THREE_FOUR\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_2K\"\r\n    },\r\n\r\n    # 图片生成 - GEM_PIX_2 (Gemini 3.0 Pro) 4K 放大版\r\n    \"gemini-3.0-pro-image-landscape-4k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_LANDSCAPE\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_4K\"\r\n    },\r\n    \"gemini-3.0-pro-image-portrait-4k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_PORTRAIT\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_4K\"\r\n    },\r\n    \"gemini-3.0-pro-image-square-4k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_SQUARE\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_4K\"\r\n    },\r\n    \"gemini-3.0-pro-image-four-three-4k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_LANDSCAPE_FOUR_THREE\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_4K\"\r\n    },\r\n    \"gemini-3.0-pro-image-three-four-4k\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"GEM_PIX_2\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_PORTRAIT_THREE_FOUR\",\r\n        \"upsample\": \"UPSAMPLE_IMAGE_RESOLUTION_4K\"\r\n    },\r\n\r\n    # 图片生成 - IMAGEN_3_5 (Imagen 4.0)\r\n    \"imagen-4.0-generate-preview-landscape\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"IMAGEN_3_5\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_LANDSCAPE\"\r\n    },\r\n    \"imagen-4.0-generate-preview-portrait\": {\r\n        \"type\": \"image\",\r\n        \"model_name\": \"IMAGEN_3_5\",\r\n        \"aspect_ratio\": \"IMAGE_ASPECT_RATIO_PORTRAIT\"\r\n    },\r\n\r\n    # ========== 文生视频 (T2V - Text to Video) ==========\r\n    # 不支持上传图片，只使用文本提示词生成\r\n\r\n    # veo_3_1_t2v_fast_portrait (竖屏)\r\n    # 上游模型名: veo_3_1_t2v_fast_portrait\r\n    \"veo_3_1_t2v_fast_portrait\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_portrait\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False\r\n    },\r\n    # veo_3_1_t2v_fast_landscape (横屏)\r\n    # 上游模型名: veo_3_1_t2v_fast\r\n    \"veo_3_1_t2v_fast_landscape\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False\r\n    },\r\n\r\n    # veo_2_1_fast_d_15_t2v (需要新增横竖屏)\r\n    \"veo_2_1_fast_d_15_t2v_portrait\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_2_1_fast_d_15_t2v\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False\r\n    },\r\n    \"veo_2_1_fast_d_15_t2v_landscape\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_2_1_fast_d_15_t2v\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False\r\n    },\r\n\r\n    # veo_2_0_t2v (需要新增横竖屏)\r\n    \"veo_2_0_t2v_portrait\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_2_0_t2v\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False\r\n    },\r\n    \"veo_2_0_t2v_landscape\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_2_0_t2v\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False\r\n    },\r\n\r\n    # veo_3_1_t2v_fast_ultra (横竖屏)\r\n    \"veo_3_1_t2v_fast_portrait_ultra\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_portrait_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False\r\n    },\r\n    \"veo_3_1_t2v_fast_ultra\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False\r\n    },\r\n\r\n    # veo_3_1_t2v_fast_ultra_relaxed (横竖屏)\r\n    \"veo_3_1_t2v_fast_portrait_ultra_relaxed\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_portrait_ultra_relaxed\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False\r\n    },\r\n    \"veo_3_1_t2v_fast_ultra_relaxed\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_ultra_relaxed\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False\r\n    },\r\n\r\n    # veo_3_1_t2v (横竖屏)\r\n    \"veo_3_1_t2v_portrait\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_portrait\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False\r\n    },\r\n    \"veo_3_1_t2v_landscape\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False\r\n    },\r\n\r\n    # ========== 首尾帧模型 (I2V - Image to Video) ==========\r\n    # 支持1-2张图片：1张作为首帧，2张作为首尾帧\r\n\r\n    # veo_3_1_i2v_s_fast_fl (需要新增横竖屏)\r\n    \"veo_3_1_i2v_s_fast_portrait_fl\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_portrait_fl\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n    \"veo_3_1_i2v_s_fast_fl\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_fl\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n\r\n    # veo_2_1_fast_d_15_i2v (需要新增横竖屏)\r\n    \"veo_2_1_fast_d_15_i2v_portrait\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_2_1_fast_d_15_i2v\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n    \"veo_2_1_fast_d_15_i2v_landscape\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_2_1_fast_d_15_i2v\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n\r\n    # veo_2_0_i2v (需要新增横竖屏)\r\n    \"veo_2_0_i2v_portrait\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_2_0_i2v\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n    \"veo_2_0_i2v_landscape\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_2_0_i2v\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n\r\n    # veo_3_1_i2v_s_fast_ultra (横竖屏)\r\n    \"veo_3_1_i2v_s_fast_portrait_ultra_fl\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_portrait_ultra_fl\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n    \"veo_3_1_i2v_s_fast_ultra_fl\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_ultra_fl\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n\r\n    # veo_3_1_i2v_s_fast_ultra_relaxed (需要新增横竖屏)\r\n    \"veo_3_1_i2v_s_fast_portrait_ultra_relaxed\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_portrait_ultra_relaxed\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n    \"veo_3_1_i2v_s_fast_ultra_relaxed\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_ultra_relaxed\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n\r\n    # veo_3_1_i2v_s (需要新增横竖屏)\r\n    \"veo_3_1_i2v_s_portrait\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n    \"veo_3_1_i2v_s_landscape\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2\r\n    },\r\n\r\n    # ========== 多图生成 (R2V - Reference Images to Video) ==========\r\n    # 支持多张图片,不限制数量\r\n\r\n    # veo_3_1_r2v_fast (横竖屏)\r\n    \"veo_3_1_r2v_fast_portrait\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast_portrait\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None  # 不限制\r\n    },\r\n    \"veo_3_1_r2v_fast\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None  # 不限制\r\n    },\r\n\r\n    # veo_3_1_r2v_fast_ultra (横竖屏)\r\n    \"veo_3_1_r2v_fast_portrait_ultra\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast_portrait_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None  # 不限制\r\n    },\r\n    \"veo_3_1_r2v_fast_ultra\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None  # 不限制\r\n    },\r\n\r\n    # veo_3_1_r2v_fast_ultra_relaxed (横竖屏)\r\n    \"veo_3_1_r2v_fast_portrait_ultra_relaxed\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast_portrait_ultra_relaxed\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None  # 不限制\r\n    },\r\n    \"veo_3_1_r2v_fast_ultra_relaxed\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast_ultra_relaxed\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None  # 不限制\r\n    },\r\n\r\n    # ========== 视频放大 (Video Upsampler) ==========\r\n    # 仅 3.1 支持，需要先生成视频后再放大，可能需要 30 分钟\r\n\r\n    # T2V 4K 放大版\r\n    \"veo_3_1_t2v_fast_portrait_4k\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_portrait\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_4K\", \"model_key\": \"veo_3_1_upsampler_4k\"}\r\n    },\r\n    \"veo_3_1_t2v_fast_4k\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_4K\", \"model_key\": \"veo_3_1_upsampler_4k\"}\r\n    },\r\n    \"veo_3_1_t2v_fast_portrait_ultra_4k\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_portrait_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_4K\", \"model_key\": \"veo_3_1_upsampler_4k\"}\r\n    },\r\n    \"veo_3_1_t2v_fast_ultra_4k\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_4K\", \"model_key\": \"veo_3_1_upsampler_4k\"}\r\n    },\r\n\r\n    # T2V 1080P 放大版\r\n    \"veo_3_1_t2v_fast_portrait_1080p\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_portrait\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_1080P\", \"model_key\": \"veo_3_1_upsampler_1080p\"}\r\n    },\r\n    \"veo_3_1_t2v_fast_1080p\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_1080P\", \"model_key\": \"veo_3_1_upsampler_1080p\"}\r\n    },\r\n    \"veo_3_1_t2v_fast_portrait_ultra_1080p\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_portrait_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": False,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_1080P\", \"model_key\": \"veo_3_1_upsampler_1080p\"}\r\n    },\r\n    \"veo_3_1_t2v_fast_ultra_1080p\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"t2v\",\r\n        \"model_key\": \"veo_3_1_t2v_fast_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": False,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_1080P\", \"model_key\": \"veo_3_1_upsampler_1080p\"}\r\n    },\r\n\r\n    # I2V 4K 放大版\r\n    \"veo_3_1_i2v_s_fast_portrait_ultra_fl_4k\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_portrait_ultra_fl\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_4K\", \"model_key\": \"veo_3_1_upsampler_4k\"}\r\n    },\r\n    \"veo_3_1_i2v_s_fast_ultra_fl_4k\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_ultra_fl\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_4K\", \"model_key\": \"veo_3_1_upsampler_4k\"}\r\n    },\r\n\r\n    # I2V 1080P 放大版\r\n    \"veo_3_1_i2v_s_fast_portrait_ultra_fl_1080p\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_portrait_ultra_fl\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_1080P\", \"model_key\": \"veo_3_1_upsampler_1080p\"}\r\n    },\r\n    \"veo_3_1_i2v_s_fast_ultra_fl_1080p\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"i2v\",\r\n        \"model_key\": \"veo_3_1_i2v_s_fast_ultra_fl\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 1,\r\n        \"max_images\": 2,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_1080P\", \"model_key\": \"veo_3_1_upsampler_1080p\"}\r\n    },\r\n\r\n    # R2V 4K 放大版\r\n    \"veo_3_1_r2v_fast_portrait_ultra_4k\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast_portrait_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_4K\", \"model_key\": \"veo_3_1_upsampler_4k\"}\r\n    },\r\n    \"veo_3_1_r2v_fast_ultra_4k\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_4K\", \"model_key\": \"veo_3_1_upsampler_4k\"}\r\n    },\r\n\r\n    # R2V 1080P 放大版\r\n    \"veo_3_1_r2v_fast_portrait_ultra_1080p\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast_portrait_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_PORTRAIT\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_1080P\", \"model_key\": \"veo_3_1_upsampler_1080p\"}\r\n    },\r\n    \"veo_3_1_r2v_fast_ultra_1080p\": {\r\n        \"type\": \"video\",\r\n        \"video_type\": \"r2v\",\r\n        \"model_key\": \"veo_3_1_r2v_fast_ultra\",\r\n        \"aspect_ratio\": \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\r\n        \"supports_images\": True,\r\n        \"min_images\": 0,\r\n        \"max_images\": None,\r\n        \"upsample\": {\"resolution\": \"VIDEO_RESOLUTION_1080P\", \"model_key\": \"veo_3_1_upsampler_1080p\"}\r\n    }\r\n}\r\n\r\n\r\nclass GenerationHandler:\r\n    \"\"\"统一生成处理器\"\"\"\r\n\r\n    def __init__(self, flow_client, token_manager, load_balancer, db, concurrency_manager, proxy_manager):\r\n        self.flow_client = flow_client\r\n        self.token_manager = token_manager\r\n        self.load_balancer = load_balancer\r\n        self.db = db\r\n        self.concurrency_manager = concurrency_manager\r\n        self.file_cache = FileCache(\r\n            cache_dir=\"tmp\",\r\n            default_timeout=config.cache_timeout,\r\n            proxy_manager=proxy_manager\r\n        )\r\n\r\n    async def check_token_availability(self, is_image: bool, is_video: bool) -> bool:\r\n        \"\"\"检查Token可用性\r\n\r\n        Args:\r\n            is_image: 是否检查图片生成Token\r\n            is_video: 是否检查视频生成Token\r\n\r\n        Returns:\r\n            True表示有可用Token, False表示无可用Token\r\n        \"\"\"\r\n        token_obj = await self.load_balancer.select_token(\r\n            for_image_generation=is_image,\r\n            for_video_generation=is_video\r\n        )\r\n        return token_obj is not None\r\n\r\n    async def handle_generation(\r\n        self,\r\n        model: str,\r\n        prompt: str,\r\n        images: Optional[List[bytes]] = None,\r\n        stream: bool = False\r\n    ) -> AsyncGenerator:\r\n        \"\"\"统一生成入口\r\n\r\n        Args:\r\n            model: 模型名称\r\n            prompt: 提示词\r\n            images: 图片列表 (bytes格式)\r\n            stream: 是否流式输出\r\n        \"\"\"\r\n        start_time = time.time()\r\n        token = None\r\n\r\n        # 1. 验证模型\r\n        if model not in MODEL_CONFIG:\r\n            error_msg = f\"不支持的模型: {model}\"\r\n            debug_logger.log_error(error_msg)\r\n            yield self._create_error_response(error_msg)\r\n            return\r\n\r\n        model_config = MODEL_CONFIG[model]\r\n        generation_type = model_config[\"type\"]\r\n        debug_logger.log_info(f\"[GENERATION] 开始生成 - 模型: {model}, 类型: {generation_type}, Prompt: {prompt[:50]}...\")\r\n\r\n        # 非流式模式: 只检查可用性\r\n        if not stream:\r\n            is_image = (generation_type == \"image\")\r\n            is_video = (generation_type == \"video\")\r\n            available = await self.check_token_availability(is_image, is_video)\r\n\r\n            if available:\r\n                if is_image:\r\n                    message = \"所有Token可用于图片生成。请启用流式模式使用生成功能。\"\r\n                else:\r\n                    message = \"所有Token可用于视频生成。请启用流式模式使用生成功能。\"\r\n            else:\r\n                if is_image:\r\n                    message = \"没有可用的Token进行图片生成\"\r\n                else:\r\n                    message = \"没有可用的Token进行视频生成\"\r\n\r\n            yield self._create_completion_response(message, is_availability_check=True)\r\n            return\r\n\r\n        # 向用户展示开始信息\r\n        if stream:\r\n            yield self._create_stream_chunk(\r\n                f\"✨ {'视频' if generation_type == 'video' else '图片'}生成任务已启动\\n\",\r\n                role=\"assistant\"\r\n            )\r\n\r\n        # 2. 选择Token\r\n        debug_logger.log_info(f\"[GENERATION] 正在选择可用Token...\")\r\n\r\n        if generation_type == \"image\":\r\n            token = await self.load_balancer.select_token(for_image_generation=True, model=model)\r\n        else:\r\n            token = await self.load_balancer.select_token(for_video_generation=True, model=model)\r\n\r\n        if not token:\r\n            error_msg = self._get_no_token_error_message(generation_type)\r\n            debug_logger.log_error(f\"[GENERATION] {error_msg}\")\r\n            if stream:\r\n                yield self._create_stream_chunk(f\"❌ {error_msg}\\n\")\r\n            yield self._create_error_response(error_msg)\r\n            return\r\n\r\n        debug_logger.log_info(f\"[GENERATION] 已选择Token: {token.id} ({token.email})\")\r\n\r\n        try:\r\n            # 3. 确保AT有效\r\n            debug_logger.log_info(f\"[GENERATION] 检查Token AT有效性...\")\r\n            if stream:\r\n                yield self._create_stream_chunk(\"初始化生成环境...\\n\")\r\n\r\n            if not await self.token_manager.is_at_valid(token.id):\r\n                error_msg = \"Token AT无效或刷新失败\"\r\n                debug_logger.log_error(f\"[GENERATION] {error_msg}\")\r\n                if stream:\r\n                    yield self._create_stream_chunk(f\"❌ {error_msg}\\n\")\r\n                yield self._create_error_response(error_msg)\r\n                return\r\n\r\n            # 重新获取token (AT可能已刷新)\r\n            token = await self.token_manager.get_token(token.id)\r\n\r\n            # 4. 确保Project存在\r\n            debug_logger.log_info(f\"[GENERATION] 检查/创建Project...\")\r\n\r\n            project_id = await self.token_manager.ensure_project_exists(token.id)\r\n            debug_logger.log_info(f\"[GENERATION] Project ID: {project_id}\")\r\n\r\n            # 5. 根据类型处理\r\n            if generation_type == \"image\":\r\n                debug_logger.log_info(f\"[GENERATION] 开始图片生成流程...\")\r\n                async for chunk in self._handle_image_generation(\r\n                    token, project_id, model_config, prompt, images, stream\r\n                ):\r\n                    yield chunk\r\n            else:  # video\r\n                debug_logger.log_info(f\"[GENERATION] 开始视频生成流程...\")\r\n                async for chunk in self._handle_video_generation(\r\n                    token, project_id, model_config, prompt, images, stream\r\n                ):\r\n                    yield chunk\r\n\r\n            # 6. 记录使用\r\n            is_video = (generation_type == \"video\")\r\n            await self.token_manager.record_usage(token.id, is_video=is_video)\r\n\r\n            # 重置错误计数 (请求成功时清空连续错误计数)\r\n            await self.token_manager.record_success(token.id)\r\n\r\n            debug_logger.log_info(f\"[GENERATION] ✅ 生成成功完成\")\r\n\r\n            # 7. 记录成功日志\r\n            duration = time.time() - start_time\r\n\r\n            # 构建响应数据，包含生成的URL\r\n            response_data = {\r\n                \"status\": \"success\",\r\n                \"model\": model,\r\n                \"prompt\": prompt[:100]\r\n            }\r\n\r\n            # 添加生成的URL（如果有）\r\n            if hasattr(self, '_last_generated_url') and self._last_generated_url:\r\n                response_data[\"url\"] = self._last_generated_url\r\n                # 清除临时存储\r\n                self._last_generated_url = None\r\n\r\n            await self._log_request(\r\n                token.id,\r\n                f\"generate_{generation_type}\",\r\n                {\"model\": model, \"prompt\": prompt[:100], \"has_images\": images is not None and len(images) > 0},\r\n                response_data,\r\n                200,\r\n                duration\r\n            )\r\n\r\n        except Exception as e:\r\n            error_msg = f\"生成失败: {str(e)}\"\r\n            debug_logger.log_error(f\"[GENERATION] ❌ {error_msg}\")\r\n            if stream:\r\n                yield self._create_stream_chunk(f\"❌ {error_msg}\\n\")\r\n            if token:\r\n                # 记录错误（所有错误统一处理，不再特殊处理429）\r\n                await self.token_manager.record_error(token.id)\r\n            yield self._create_error_response(error_msg)\r\n\r\n            # 记录失败日志\r\n            duration = time.time() - start_time\r\n            await self._log_request(\r\n                token.id if token else None,\r\n                f\"generate_{generation_type if model_config else 'unknown'}\",\r\n                {\"model\": model, \"prompt\": prompt[:100], \"has_images\": images is not None and len(images) > 0},\r\n                {\"error\": error_msg},\r\n                500,\r\n                duration\r\n            )\r\n\r\n    def _get_no_token_error_message(self, generation_type: str) -> str:\r\n        \"\"\"获取无可用Token时的详细错误信息\"\"\"\r\n        if generation_type == \"image\":\r\n            return \"没有可用的Token进行图片生成。所有Token都处于禁用、冷却、锁定或已过期状态。\"\r\n        else:\r\n            return \"没有可用的Token进行视频生成。所有Token都处于禁用、冷却、配额耗尽或已过期状态。\"\r\n\r\n    async def _handle_image_generation(\r\n        self,\r\n        token,\r\n        project_id: str,\r\n        model_config: dict,\r\n        prompt: str,\r\n        images: Optional[List[bytes]],\r\n        stream: bool\r\n    ) -> AsyncGenerator:\r\n        \"\"\"处理图片生成 (同步返回)\"\"\"\r\n\r\n        # 获取并发槽位\r\n        if self.concurrency_manager:\r\n            if not await self.concurrency_manager.acquire_image(token.id):\r\n                yield self._create_error_response(\"图片并发限制已达上限\")\r\n                return\r\n\r\n        try:\r\n            # 上传图片 (如果有)\r\n            image_inputs = []\r\n            if images and len(images) > 0:\r\n                if stream:\r\n                    yield self._create_stream_chunk(f\"上传 {len(images)} 张参考图片...\\n\")\r\n\r\n                # 支持多图输入\r\n                for idx, image_bytes in enumerate(images):\r\n                    media_id = await self.flow_client.upload_image(\r\n                        token.at,\r\n                        image_bytes,\r\n                        model_config[\"aspect_ratio\"]\r\n                    )\r\n                    image_inputs.append({\r\n                        \"name\": media_id,\r\n                        \"imageInputType\": \"IMAGE_INPUT_TYPE_REFERENCE\"\r\n                    })\r\n                    if stream:\r\n                        yield self._create_stream_chunk(f\"已上传第 {idx + 1}/{len(images)} 张图片\\n\")\r\n\r\n            # 调用生成API\r\n            if stream:\r\n                yield self._create_stream_chunk(\"正在生成图片...\\n\")\r\n\r\n            result = await self.flow_client.generate_image(\r\n                at=token.at,\r\n                project_id=project_id,\r\n                prompt=prompt,\r\n                model_name=model_config[\"model_name\"],\r\n                aspect_ratio=model_config[\"aspect_ratio\"],\r\n                image_inputs=image_inputs\r\n            )\r\n\r\n            # 提取URL和mediaId\r\n            media = result.get(\"media\", [])\r\n            if not media:\r\n                yield self._create_error_response(\"生成结果为空\")\r\n                return\r\n\r\n            image_url = media[0][\"image\"][\"generatedImage\"][\"fifeUrl\"]\r\n            media_id = media[0].get(\"name\")  # 用于 upsample\r\n\r\n            # 检查是否需要 upsample\r\n            upsample_resolution = model_config.get(\"upsample\")\r\n            if upsample_resolution and media_id:\r\n                resolution_name = \"4K\" if \"4K\" in upsample_resolution else \"2K\"\r\n                if stream:\r\n                    yield self._create_stream_chunk(f\"正在放大图片到 {resolution_name}...\\n\")\r\n\r\n                # 4K/2K 图片重试逻辑 - 最多重试3次\r\n                max_retries = 3\r\n                for retry_attempt in range(max_retries):\r\n                    try:\r\n                        # 调用 upsample API\r\n                        encoded_image = await self.flow_client.upsample_image(\r\n                            at=token.at,\r\n                            project_id=project_id,\r\n                            media_id=media_id,\r\n                            target_resolution=upsample_resolution\r\n                        )\r\n\r\n                        if encoded_image:\r\n                            debug_logger.log_info(f\"[UPSAMPLE] 图片已放大到 {resolution_name}\")\r\n\r\n                            if stream:\r\n                                yield self._create_stream_chunk(f\"✅ 图片已放大到 {resolution_name}\\n\")\r\n\r\n                            # 缓存放大后的图片 (如果启用)\r\n                            # 日志统一记录原图URL (放大后的base64数据太大，不适合存储)\r\n                            self._last_generated_url = image_url\r\n\r\n                            if config.cache_enabled:\r\n                                try:\r\n                                    if stream:\r\n                                        yield self._create_stream_chunk(f\"缓存 {resolution_name} 图片中...\\n\")\r\n                                    cached_filename = await self.file_cache.cache_base64_image(encoded_image, resolution_name)\r\n                                    local_url = f\"{self._get_base_url()}/tmp/{cached_filename}\"\r\n                                    if stream:\r\n                                        yield self._create_stream_chunk(f\"✅ {resolution_name} 图片缓存成功\\n\")\r\n                                        yield self._create_stream_chunk(\r\n                                            f\"![Generated Image]({local_url})\",\r\n                                            finish_reason=\"stop\"\r\n                                        )\r\n                                    else:\r\n                                        yield self._create_completion_response(\r\n                                            local_url,\r\n                                            media_type=\"image\"\r\n                                        )\r\n                                    return\r\n                                except Exception as e:\r\n                                    debug_logger.log_error(f\"Failed to cache {resolution_name} image: {str(e)}\")\r\n                                    if stream:\r\n                                        yield self._create_stream_chunk(f\"⚠️ 缓存失败: {str(e)}，返回 base64...\\n\")\r\n\r\n                            # 缓存未启用或缓存失败，返回 base64 格式\r\n                            base64_url = f\"data:image/jpeg;base64,{encoded_image}\"\r\n                            if stream:\r\n                                yield self._create_stream_chunk(\r\n                                    f\"![Generated Image]({base64_url})\",\r\n                                    finish_reason=\"stop\"\r\n                                )\r\n                            else:\r\n                                yield self._create_completion_response(\r\n                                    base64_url,\r\n                                    media_type=\"image\"\r\n                                )\r\n                            return\r\n                        else:\r\n                            debug_logger.log_warning(\"[UPSAMPLE] 返回结果为空\")\r\n                            if stream:\r\n                                yield self._create_stream_chunk(f\"⚠️ 放大失败，返回原图...\\n\")\r\n                            break  # 空结果不重试\r\n\r\n                    except Exception as e:\r\n                        error_str = str(e)\r\n                        debug_logger.log_error(f\"[UPSAMPLE] 放大失败 (尝试 {retry_attempt + 1}/{max_retries}): {error_str}\")\r\n                        \r\n                        # 检查是否是可重试错误（403、reCAPTCHA、超时等）\r\n                        retry_reason = self.flow_client._get_retry_reason(error_str)\r\n                        if retry_reason and retry_attempt < max_retries - 1:\r\n                            if stream:\r\n                                yield self._create_stream_chunk(f\"⚠️ 放大遇到{retry_reason}，正在重试 ({retry_attempt + 2}/{max_retries})...\\n\")\r\n                            # 等待一小段时间后重试\r\n                            await asyncio.sleep(1)\r\n                            continue\r\n                        else:\r\n                            if stream:\r\n                                yield self._create_stream_chunk(f\"⚠️ 放大失败: {error_str}，返回原图...\\n\")\r\n                            break\r\n\r\n            # 缓存图片 (如果启用)\r\n            local_url = image_url\r\n            if config.cache_enabled:\r\n                try:\r\n                    if stream:\r\n                        yield self._create_stream_chunk(\"缓存图片中...\\n\")\r\n                    cached_filename = await self.file_cache.download_and_cache(image_url, \"image\")\r\n                    local_url = f\"{self._get_base_url()}/tmp/{cached_filename}\"\r\n                    if stream:\r\n                        yield self._create_stream_chunk(\"✅ 图片缓存成功,准备返回缓存地址...\\n\")\r\n                except Exception as e:\r\n                    debug_logger.log_error(f\"Failed to cache image: {str(e)}\")\r\n                    # 缓存失败不影响结果返回,使用原始URL\r\n                    local_url = image_url\r\n                    if stream:\r\n                        yield self._create_stream_chunk(f\"⚠️ 缓存失败: {str(e)}\\n正在返回源链接...\\n\")\r\n            else:\r\n                if stream:\r\n                    yield self._create_stream_chunk(\"缓存已关闭,正在返回源链接...\\n\")\r\n\r\n            # 返回结果\r\n            # 存储URL用于日志记录\r\n            self._last_generated_url = local_url\r\n\r\n            if stream:\r\n                yield self._create_stream_chunk(\r\n                    f\"![Generated Image]({local_url})\",\r\n                    finish_reason=\"stop\"\r\n                )\r\n            else:\r\n                yield self._create_completion_response(\r\n                    local_url,  # 直接传URL,让方法内部格式化\r\n                    media_type=\"image\"\r\n                )\r\n\r\n        finally:\r\n            # 释放并发槽位\r\n            if self.concurrency_manager:\r\n                await self.concurrency_manager.release_image(token.id)\r\n\r\n    async def _handle_video_generation(\r\n        self,\r\n        token,\r\n        project_id: str,\r\n        model_config: dict,\r\n        prompt: str,\r\n        images: Optional[List[bytes]],\r\n        stream: bool\r\n    ) -> AsyncGenerator:\r\n        \"\"\"处理视频生成 (异步轮询)\"\"\"\r\n\r\n        # 获取并发槽位\r\n        if self.concurrency_manager:\r\n            if not await self.concurrency_manager.acquire_video(token.id):\r\n                yield self._create_error_response(\"视频并发限制已达上限\")\r\n                return\r\n\r\n        try:\r\n            # 获取模型类型和配置\r\n            video_type = model_config.get(\"video_type\")\r\n            supports_images = model_config.get(\"supports_images\", False)\r\n            min_images = model_config.get(\"min_images\", 0)\r\n            max_images = model_config.get(\"max_images\", 0)\r\n\r\n            # 根据账号tier自动调整模型 key\r\n            model_key = model_config[\"model_key\"]\r\n            user_tier = token.user_paygate_tier or \"PAYGATE_TIER_ONE\"\r\n\r\n            # TIER_TWO 账号需要使用 ultra 版本的模型\r\n            if user_tier == \"PAYGATE_TIER_TWO\":\r\n                # 如果模型 key 不包含 ultra，自动添加\r\n                if \"ultra\" not in model_key:\r\n                    # veo_3_1_i2v_s_fast_fl -> veo_3_1_i2v_s_fast_ultra_fl\r\n                    # veo_3_1_i2v_s_fast_portrait_fl -> veo_3_1_i2v_s_fast_portrait_ultra_fl\r\n                    # veo_3_1_t2v_fast -> veo_3_1_t2v_fast_ultra\r\n                    # veo_3_1_t2v_fast_portrait -> veo_3_1_t2v_fast_portrait_ultra\r\n                    # veo_3_0_r2v_fast -> veo_3_0_r2v_fast_ultra\r\n                    if \"_fl\" in model_key:\r\n                        model_key = model_key.replace(\"_fl\", \"_ultra_fl\")\r\n                    else:\r\n                        # 直接在末尾添加 _ultra\r\n                        model_key = model_key + \"_ultra\"\r\n                    \r\n                    if stream:\r\n                        yield self._create_stream_chunk(f\"TIER_TWO 账号自动切换到 ultra 模型: {model_key}\\n\")\r\n                    debug_logger.log_info(f\"[VIDEO] TIER_TWO 账号，模型自动调整: {model_config['model_key']} -> {model_key}\")\r\n\r\n            # TIER_ONE 账号需要使用非 ultra 版本\r\n            elif user_tier == \"PAYGATE_TIER_ONE\":\r\n                # 如果模型 key 包含 ultra，需要移除（避免用户误用）\r\n                if \"ultra\" in model_key:\r\n                    # veo_3_1_i2v_s_fast_ultra_fl -> veo_3_1_i2v_s_fast_fl\r\n                    # veo_3_1_t2v_fast_ultra -> veo_3_1_t2v_fast\r\n                    model_key = model_key.replace(\"_ultra_fl\", \"_fl\").replace(\"_ultra\", \"\")\r\n                    \r\n                    if stream:\r\n                        yield self._create_stream_chunk(f\"TIER_ONE 账号自动切换到标准模型: {model_key}\\n\")\r\n                    debug_logger.log_info(f\"[VIDEO] TIER_ONE 账号，模型自动调整: {model_config['model_key']} -> {model_key}\")\r\n\r\n            # 更新 model_config 中的 model_key\r\n            model_config = dict(model_config)  # 创建副本避免修改原配置\r\n            model_config[\"model_key\"] = model_key\r\n\r\n            # 图片数量\r\n            image_count = len(images) if images else 0\r\n\r\n            # ========== 验证和处理图片 ==========\r\n\r\n            # T2V: 文生视频 - 不支持图片\r\n            if video_type == \"t2v\":\r\n                if image_count > 0:\r\n                    if stream:\r\n                        yield self._create_stream_chunk(\"⚠️ 文生视频模型不支持上传图片,将忽略图片仅使用文本提示词生成\\n\")\r\n                    debug_logger.log_warning(f\"[T2V] 模型 {model_config['model_key']} 不支持图片,已忽略 {image_count} 张图片\")\r\n                images = None  # 清空图片\r\n                image_count = 0\r\n\r\n            # I2V: 首尾帧模型 - 需要1-2张图片\r\n            elif video_type == \"i2v\":\r\n                if image_count < min_images or image_count > max_images:\r\n                    error_msg = f\"❌ 首尾帧模型需要 {min_images}-{max_images} 张图片,当前提供了 {image_count} 张\"\r\n                    if stream:\r\n                        yield self._create_stream_chunk(f\"{error_msg}\\n\")\r\n                    yield self._create_error_response(error_msg)\r\n                    return\r\n\r\n            # R2V: 多图生成 - 支持多张图片,不限制数量\r\n            elif video_type == \"r2v\":\r\n                # 不再限制最大图片数量\r\n                pass\r\n\r\n            # ========== 上传图片 ==========\r\n            start_media_id = None\r\n            end_media_id = None\r\n            reference_images = []\r\n\r\n            # I2V: 首尾帧处理\r\n            if video_type == \"i2v\" and images:\r\n                if image_count == 1:\r\n                    # 只有1张图: 仅作为首帧\r\n                    if stream:\r\n                        yield self._create_stream_chunk(\"上传首帧图片...\\n\")\r\n                    start_media_id = await self.flow_client.upload_image(\r\n                        token.at, images[0], model_config[\"aspect_ratio\"]\r\n                    )\r\n                    debug_logger.log_info(f\"[I2V] 仅上传首帧: {start_media_id}\")\r\n\r\n                elif image_count == 2:\r\n                    # 2张图: 首帧+尾帧\r\n                    if stream:\r\n                        yield self._create_stream_chunk(\"上传首帧和尾帧图片...\\n\")\r\n                    start_media_id = await self.flow_client.upload_image(\r\n                        token.at, images[0], model_config[\"aspect_ratio\"]\r\n                    )\r\n                    end_media_id = await self.flow_client.upload_image(\r\n                        token.at, images[1], model_config[\"aspect_ratio\"]\r\n                    )\r\n                    debug_logger.log_info(f\"[I2V] 上传首尾帧: {start_media_id}, {end_media_id}\")\r\n\r\n            # R2V: 多图处理\r\n            elif video_type == \"r2v\" and images:\r\n                if stream:\r\n                    yield self._create_stream_chunk(f\"上传 {image_count} 张参考图片...\\n\")\r\n\r\n                for idx, img in enumerate(images):  # 上传所有图片,不限制数量\r\n                    media_id = await self.flow_client.upload_image(\r\n                        token.at, img, model_config[\"aspect_ratio\"]\r\n                    )\r\n                    reference_images.append({\r\n                        \"imageUsageType\": \"IMAGE_USAGE_TYPE_ASSET\",\r\n                        \"mediaId\": media_id\r\n                    })\r\n                debug_logger.log_info(f\"[R2V] 上传了 {len(reference_images)} 张参考图片\")\r\n\r\n            # ========== 调用生成API ==========\r\n            if stream:\r\n                yield self._create_stream_chunk(\"提交视频生成任务...\\n\")\r\n\r\n            # I2V: 首尾帧生成\r\n            if video_type == \"i2v\" and start_media_id:\r\n                if end_media_id:\r\n                    # 有首尾帧\r\n                    result = await self.flow_client.generate_video_start_end(\r\n                        at=token.at,\r\n                        project_id=project_id,\r\n                        prompt=prompt,\r\n                        model_key=model_config[\"model_key\"],\r\n                        aspect_ratio=model_config[\"aspect_ratio\"],\r\n                        start_media_id=start_media_id,\r\n                        end_media_id=end_media_id,\r\n                        user_paygate_tier=token.user_paygate_tier or \"PAYGATE_TIER_ONE\"\r\n                    )\r\n                else:\r\n                    # 只有首帧 - 需要去掉 model_key 中的 _fl\r\n                    # 情况1: _fl_ 在中间 (如 veo_3_1_i2v_s_fast_fl_ultra_relaxed -> veo_3_1_i2v_s_fast_ultra_relaxed)\r\n                    # 情况2: _fl 在结尾 (如 veo_3_1_i2v_s_fast_ultra_fl -> veo_3_1_i2v_s_fast_ultra)\r\n                    actual_model_key = model_config[\"model_key\"].replace(\"_fl_\", \"_\")\r\n                    if actual_model_key.endswith(\"_fl\"):\r\n                        actual_model_key = actual_model_key[:-3]\r\n                    debug_logger.log_info(f\"[I2V] 单帧模式，model_key: {model_config['model_key']} -> {actual_model_key}\")\r\n                    result = await self.flow_client.generate_video_start_image(\r\n                        at=token.at,\r\n                        project_id=project_id,\r\n                        prompt=prompt,\r\n                        model_key=actual_model_key,\r\n                        aspect_ratio=model_config[\"aspect_ratio\"],\r\n                        start_media_id=start_media_id,\r\n                        user_paygate_tier=token.user_paygate_tier or \"PAYGATE_TIER_ONE\"\r\n                    )\r\n\r\n            # R2V: 多图生成\r\n            elif video_type == \"r2v\" and reference_images:\r\n                result = await self.flow_client.generate_video_reference_images(\r\n                    at=token.at,\r\n                    project_id=project_id,\r\n                    prompt=prompt,\r\n                    model_key=model_config[\"model_key\"],\r\n                    aspect_ratio=model_config[\"aspect_ratio\"],\r\n                    reference_images=reference_images,\r\n                    user_paygate_tier=token.user_paygate_tier or \"PAYGATE_TIER_ONE\"\r\n                )\r\n\r\n            # T2V 或 R2V无图: 纯文本生成\r\n            else:\r\n                result = await self.flow_client.generate_video_text(\r\n                    at=token.at,\r\n                    project_id=project_id,\r\n                    prompt=prompt,\r\n                    model_key=model_config[\"model_key\"],\r\n                    aspect_ratio=model_config[\"aspect_ratio\"],\r\n                    user_paygate_tier=token.user_paygate_tier or \"PAYGATE_TIER_ONE\"\r\n                )\r\n\r\n            # 获取task_id和operations\r\n            operations = result.get(\"operations\", [])\r\n            if not operations:\r\n                yield self._create_error_response(\"生成任务创建失败\")\r\n                return\r\n\r\n            operation = operations[0]\r\n            task_id = operation[\"operation\"][\"name\"]\r\n            scene_id = operation.get(\"sceneId\")\r\n\r\n            # 保存Task到数据库\r\n            task = Task(\r\n                task_id=task_id,\r\n                token_id=token.id,\r\n                model=model_config[\"model_key\"],\r\n                prompt=prompt,\r\n                status=\"processing\",\r\n                scene_id=scene_id\r\n            )\r\n            await self.db.create_task(task)\r\n\r\n            # 轮询结果\r\n            if stream:\r\n                yield self._create_stream_chunk(f\"视频生成中...\\n\")\r\n\r\n            # 检查是否需要放大\r\n            upsample_config = model_config.get(\"upsample\")\r\n\r\n            async for chunk in self._poll_video_result(token, project_id, operations, stream, upsample_config):\r\n                yield chunk\r\n\r\n        finally:\r\n            # 释放并发槽位\r\n            if self.concurrency_manager:\r\n                await self.concurrency_manager.release_video(token.id)\r\n\r\n    async def _poll_video_result(\r\n        self,\r\n        token,\r\n        project_id: str,\r\n        operations: List[Dict],\r\n        stream: bool,\r\n        upsample_config: Optional[Dict] = None\r\n    ) -> AsyncGenerator:\r\n        \"\"\"轮询视频生成结果\r\n        \r\n        Args:\r\n            upsample_config: 放大配置 {\"resolution\": \"VIDEO_RESOLUTION_4K\", \"model_key\": \"veo_3_1_upsampler_4k\"}\r\n        \"\"\"\r\n\r\n        max_attempts = config.max_poll_attempts\r\n        poll_interval = config.poll_interval\r\n        \r\n        # 如果需要放大，轮询次数加倍（放大可能需要 30 分钟）\r\n        if upsample_config:\r\n            max_attempts = max_attempts * 3  # 放大需要更长时间\r\n\r\n        for attempt in range(max_attempts):\r\n            await asyncio.sleep(poll_interval)\r\n\r\n            try:\r\n                result = await self.flow_client.check_video_status(token.at, operations)\r\n                checked_operations = result.get(\"operations\", [])\r\n\r\n                if not checked_operations:\r\n                    continue\r\n\r\n                operation = checked_operations[0]\r\n                status = operation.get(\"status\")\r\n\r\n                # 状态更新 - 每20秒报告一次 (poll_interval=3秒, 20秒约7次轮询)\r\n                progress_update_interval = 7  # 每7次轮询 = 21秒\r\n                if stream and attempt % progress_update_interval == 0:  # 每20秒报告一次\r\n                    progress = min(int((attempt / max_attempts) * 100), 95)\r\n                    yield self._create_stream_chunk(f\"生成进度: {progress}%\\n\")\r\n\r\n                # 检查状态\r\n                if status == \"MEDIA_GENERATION_STATUS_SUCCESSFUL\":\r\n                    # 成功\r\n                    metadata = operation[\"operation\"].get(\"metadata\", {})\r\n                    video_info = metadata.get(\"video\", {})\r\n                    video_url = video_info.get(\"fifeUrl\")\r\n                    video_media_id = video_info.get(\"mediaGenerationId\")\r\n                    aspect_ratio = video_info.get(\"aspectRatio\", \"VIDEO_ASPECT_RATIO_LANDSCAPE\")\r\n\r\n                    if not video_url:\r\n                        yield self._create_error_response(\"视频URL为空\")\r\n                        return\r\n\r\n                    # ========== 视频放大处理 ==========\r\n                    if upsample_config and video_media_id:\r\n                        if stream:\r\n                            resolution_name = \"4K\" if \"4K\" in upsample_config[\"resolution\"] else \"1080P\"\r\n                            yield self._create_stream_chunk(f\"\\n视频生成完成，开始 {resolution_name} 放大处理...（可能需要 30 分钟）\\n\")\r\n                        \r\n                        try:\r\n                            # 提交放大任务\r\n                            upsample_result = await self.flow_client.upsample_video(\r\n                                at=token.at,\r\n                                project_id=project_id,\r\n                                video_media_id=video_media_id,\r\n                                aspect_ratio=aspect_ratio,\r\n                                resolution=upsample_config[\"resolution\"],\r\n                                model_key=upsample_config[\"model_key\"]\r\n                            )\r\n                            \r\n                            upsample_operations = upsample_result.get(\"operations\", [])\r\n                            if upsample_operations:\r\n                                if stream:\r\n                                    yield self._create_stream_chunk(\"放大任务已提交，继续轮询...\\n\")\r\n                                \r\n                                # 递归轮询放大结果（不再放大）\r\n                                async for chunk in self._poll_video_result(\r\n                                    token, project_id, upsample_operations, stream, None\r\n                                ):\r\n                                    yield chunk\r\n                                return\r\n                            else:\r\n                                if stream:\r\n                                    yield self._create_stream_chunk(\"⚠️ 放大任务创建失败，返回原始视频\\n\")\r\n                        except Exception as e:\r\n                            debug_logger.log_error(f\"Video upsample failed: {str(e)}\")\r\n                            if stream:\r\n                                yield self._create_stream_chunk(f\"⚠️ 放大失败: {str(e)}，返回原始视频\\n\")\r\n\r\n                    # 缓存视频 (如果启用)\r\n                    local_url = video_url\r\n                    if config.cache_enabled:\r\n                        try:\r\n                            if stream:\r\n                                yield self._create_stream_chunk(\"正在缓存视频文件...\\n\")\r\n                            cached_filename = await self.file_cache.download_and_cache(video_url, \"video\")\r\n                            local_url = f\"{self._get_base_url()}/tmp/{cached_filename}\"\r\n                            if stream:\r\n                                yield self._create_stream_chunk(\"✅ 视频缓存成功,准备返回缓存地址...\\n\")\r\n                        except Exception as e:\r\n                            debug_logger.log_error(f\"Failed to cache video: {str(e)}\")\r\n                            # 缓存失败不影响结果返回,使用原始URL\r\n                            local_url = video_url\r\n                            if stream:\r\n                                yield self._create_stream_chunk(f\"⚠️ 缓存失败: {str(e)}\\n正在返回源链接...\\n\")\r\n                    else:\r\n                        if stream:\r\n                            yield self._create_stream_chunk(\"缓存已关闭,正在返回源链接...\\n\")\r\n\r\n                    # 更新数据库\r\n                    task_id = operation[\"operation\"][\"name\"]\r\n                    await self.db.update_task(\r\n                        task_id,\r\n                        status=\"completed\",\r\n                        progress=100,\r\n                        result_urls=[local_url],\r\n                        completed_at=time.time()\r\n                    )\r\n\r\n                    # 存储URL用于日志记录\r\n                    self._last_generated_url = local_url\r\n\r\n                    # 返回结果\r\n                    if stream:\r\n                        yield self._create_stream_chunk(\r\n                            f\"<video src='{local_url}' controls style='max-width:100%'></video>\",\r\n                            finish_reason=\"stop\"\r\n                        )\r\n                    else:\r\n                        yield self._create_completion_response(\r\n                            local_url,  # 直接传URL,让方法内部格式化\r\n                            media_type=\"video\"\r\n                        )\r\n                    return\r\n\r\n                elif status == \"MEDIA_GENERATION_STATUS_FAILED\":\r\n                    # 生成失败 - 提取错误信息\r\n                    error_info = operation.get(\"operation\", {}).get(\"error\", {})\r\n                    error_code = error_info.get(\"code\", \"unknown\")\r\n                    error_message = error_info.get(\"message\", \"未知错误\")\r\n                    \r\n                    # 更新数据库任务状态\r\n                    task_id = operation[\"operation\"][\"name\"]\r\n                    await self.db.update_task(\r\n                        task_id,\r\n                        status=\"failed\",\r\n                        error_message=f\"{error_message} (code: {error_code})\",\r\n                        completed_at=time.time()\r\n                    )\r\n                    \r\n                    # 返回友好的错误消息，提示用户重试\r\n                    friendly_error = f\"视频生成失败: {error_message}，请重试\"\r\n                    if stream:\r\n                        yield self._create_stream_chunk(f\"❌ {friendly_error}\\n\")\r\n                    yield self._create_error_response(friendly_error)\r\n                    return\r\n\r\n                elif status.startswith(\"MEDIA_GENERATION_STATUS_ERROR\"):\r\n                    # 其他错误状态\r\n                    yield self._create_error_response(f\"视频生成失败: {status}\")\r\n                    return\r\n\r\n            except Exception as e:\r\n                debug_logger.log_error(f\"Poll error: {str(e)}\")\r\n                continue\r\n\r\n        # 超时\r\n        yield self._create_error_response(f\"视频生成超时 (已轮询{max_attempts}次)\")\r\n\r\n    # ========== 响应格式化 ==========\r\n\r\n    def _create_stream_chunk(self, content: str, role: str = None, finish_reason: str = None) -> str:\r\n        \"\"\"创建流式响应chunk\"\"\"\r\n        import json\r\n        import time\r\n\r\n        chunk = {\r\n            \"id\": f\"chatcmpl-{int(time.time())}\",\r\n            \"object\": \"chat.completion.chunk\",\r\n            \"created\": int(time.time()),\r\n            \"model\": \"flow2api\",\r\n            \"choices\": [{\r\n                \"index\": 0,\r\n                \"delta\": {},\r\n                \"finish_reason\": finish_reason\r\n            }]\r\n        }\r\n\r\n        if role:\r\n            chunk[\"choices\"][0][\"delta\"][\"role\"] = role\r\n\r\n        if finish_reason:\r\n            chunk[\"choices\"][0][\"delta\"][\"content\"] = content\r\n        else:\r\n            chunk[\"choices\"][0][\"delta\"][\"reasoning_content\"] = content\r\n\r\n        return f\"data: {json.dumps(chunk, ensure_ascii=False)}\\n\\n\"\r\n\r\n    def _create_completion_response(self, content: str, media_type: str = \"image\", is_availability_check: bool = False) -> str:\r\n        \"\"\"创建非流式响应\r\n\r\n        Args:\r\n            content: 媒体URL或纯文本消息\r\n            media_type: 媒体类型 (\"image\" 或 \"video\")\r\n            is_availability_check: 是否为可用性检查响应 (纯文本消息)\r\n\r\n        Returns:\r\n            JSON格式的响应\r\n        \"\"\"\r\n        import json\r\n        import time\r\n\r\n        # 可用性检查: 返回纯文本消息\r\n        if is_availability_check:\r\n            formatted_content = content\r\n        else:\r\n            # 媒体生成: 根据媒体类型格式化内容为Markdown\r\n            if media_type == \"video\":\r\n                formatted_content = f\"```html\\n<video src='{content}' controls></video>\\n```\"\r\n            else:  # image\r\n                formatted_content = f\"![Generated Image]({content})\"\r\n\r\n        response = {\r\n            \"id\": f\"chatcmpl-{int(time.time())}\",\r\n            \"object\": \"chat.completion\",\r\n            \"created\": int(time.time()),\r\n            \"model\": \"flow2api\",\r\n            \"choices\": [{\r\n                \"index\": 0,\r\n                \"message\": {\r\n                    \"role\": \"assistant\",\r\n                    \"content\": formatted_content\r\n                },\r\n                \"finish_reason\": \"stop\"\r\n            }]\r\n        }\r\n\r\n        return json.dumps(response, ensure_ascii=False)\r\n\r\n    def _create_error_response(self, error_message: str) -> str:\r\n        \"\"\"创建错误响应\"\"\"\r\n        import json\r\n\r\n        error = {\r\n            \"error\": {\r\n                \"message\": error_message,\r\n                \"type\": \"invalid_request_error\",\r\n                \"code\": \"generation_failed\"\r\n            }\r\n        }\r\n\r\n        return json.dumps(error, ensure_ascii=False)\r\n\r\n    def _get_base_url(self) -> str:\r\n        \"\"\"获取基础URL用于缓存文件访问\"\"\"\r\n        # 优先使用配置的cache_base_url\r\n        if config.cache_base_url:\r\n            return config.cache_base_url\r\n        # 否则使用服务器地址\r\n        return f\"http://{config.server_host}:{config.server_port}\"\r\n\r\n    async def _log_request(\r\n        self,\r\n        token_id: Optional[int],\r\n        operation: str,\r\n        request_data: Dict[str, Any],\r\n        response_data: Dict[str, Any],\r\n        status_code: int,\r\n        duration: float\r\n    ):\r\n        \"\"\"记录请求到数据库\"\"\"\r\n        try:\r\n            log = RequestLog(\r\n                token_id=token_id,\r\n                operation=operation,\r\n                request_body=json.dumps(request_data, ensure_ascii=False),\r\n                response_body=json.dumps(response_data, ensure_ascii=False),\r\n                status_code=status_code,\r\n                duration=duration\r\n            )\r\n            await self.db.add_request_log(log)\r\n        except Exception as e:\r\n            # 日志记录失败不影响主流程\r\n            debug_logger.log_error(f\"Failed to log request: {e}\")\r\n"
        }
    ]
}